create warehouse capgemini
create database capgeminisprint1

CREATE STORAGE INTEGRATION SUPERSTORE_INT
TYPE = EXTERNAL_STAGE
STORAGE_PROVIDER = 'S3'
ENABLED = TRUE
STORAGE_AWS_ROLE_ARN = 'arn:aws:iam::214327599109:role/superstoreRole'
STORAGE_ALLOWED_LOCATIONS = ('s3://samplesuperstore/')

--To get arn and external id key to insert in role

DESC INTEGRATION SUPERSTORE_INT;

GRANT CREATE STAGE ON SCHEMA PUBLIC TO ROLE ACCOUNTADMIN;

GRANT USAGE ON INTEGRATION SUPERSTORE_INT TO ROLE ACCOUNTADMIN;

CREATE OR REPLACE FILE FORMAT SUPERSTORE_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1;

--Creating external stage 
CREATE STAGE SUPERSTORE_STAGE
STORAGE_INTEGRATION = SUPERSTORE_INT
URL = 's3://samplesuperstore/'
FILE_FORMAT = SUPERSTORE_FORMAT;

CREATE OR REPLACE TABLE CAPGEMINISPRINT1.PUBLIC.SAMPLE_SUPERSTORE
(
  ROWID NUMBER,
  ORDERID VARCHAR,
  ORDERDATE VARCHAR,
  SHIPDATE VARCHAR,
  SHIPMODE VARCHAR,
  CUSTOMERID VARCHAR,
  CUSTOMERNAME VARCHAR,
  SEGMENT VARCHAR,
  COUNTRY VARCHAR,
  CITY VARCHAR,
  STATE VARCHAR,
  POSTALCODE VARCHAR,
  REGION VARCHAR,
  PRODUCTID VARCHAR,
  CATEGORY VARCHAR,
  SUBCATEGORY VARCHAR,
  PRODUCTNAME VARCHAR,
  SALES VARCHAR,
  QUANTITY VARCHAR,
  DISCOUNT VARCHAR,
  PROFIT NUMBER
);

--Checking s3 integration 
COPY INTO CAPGEMINISPRINT1.PUBLIC.SAMPLE_SUPERSTORE
FROM @SUPERSTORE_STAGE/Sample-Superstore3.csv
ON_ERROR = 'SKIP_FILE';

SELECT * FROM CAPGEMINISPRINT1.PUBLIC.SAMPLE_SUPERSTORE;

--Creating pipe 
CREATE PIPE CAPGEMINISPRINT1.PUBLIC.MYPIPE AUTO_INGEST=TRUE AS
COPY INTO CAPGEMINISPRINT1.PUBLIC.SAMPLE_SUPERSTORE FROM @CAPGEMINISPRINT1.PUBLIC.SUPERSTORE_STAGE
FILE_FORMAT = (TYPE = 'CSV');

SHOW PIPES

SELECT COUNT(*) FROM CAPGEMINISPRINT1.PUBLIC.SAMPLE_SUPERSTORE;
SELECT * FROM CAPGEMINISPRINT1.PUBLIC.SAMPLE_SUPERSTORE;